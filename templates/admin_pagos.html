<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Placas - Panel de Pagos</title>
    <!-- NOTA: Usamos los mismos estilos que envios.html para consistencia -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos generales */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }

        /* Cabecera (copiada de envios.html) */
        .header {
            background: linear-gradient(135deg, #1e1e1e, #2c2c2c);
            color: #ffffff;
            padding: 40px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .header img {
            width: 50px;
            height: 50px;
            margin-right: 15px;
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0;
        }
        .header p {
            font-size: 1.2rem;
            font-weight: 400;
            margin: 0;
        }

        /* Contenedor principal */
        .container-fluid { 
            max-width: 1400px; 
            margin: 0 auto;
            padding: 30px;
        }
        .section-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
        }
        
        /* Estilos para la lista de pagos */
        .list-group-item {
            background-color: #1e1e1e;
            border: 1px solid #333;
            color: #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Para móviles */
        }
        .list-group-item:first-child {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }
        .list-group-item:last-child {
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }
        .payment-info {
            flex-grow: 1;
            margin-right: 1rem;
        }
        .payment-info strong {
            color: #FFC107;
            font-size: 1.1rem;
        }
        .payment-info span {
            color: #999;
            font-size: 0.9rem;
            margin: 0 5px;
        }
        .payment-actions {
            display: flex;
            align-items: center;
            margin-top: 10px; /* Para móviles */
        }
        .form-control-dark {
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
            max-width: 150px;
            margin-right: 10px;
        }
        .btn-warning {
             background-color: #FFC107;
             border-color: #FFC107;
             color: #121212;
             font-weight: 600;
        }
        
        /* Mensaje de feedback */
        .feedback-message {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 1050;
        }
        .feedback-success {
            background-color: #28a745;
            color: white;
        }
        .feedback-error {
            background-color: #dc3545;
            color: white;
        }
        
        @media (max-width: 576px) {
            .payment-info {
                width: 100%;
                margin-bottom: 10px;
            }
            .payment-actions {
                width: 100%;
                justify-content: space-between;
            }
            .form-control-dark {
                flex-grow: 1;
            }
        }
    </style>
</head>
<body>

    <!-- Cabecera (Copiada de envios.html) -->
    <div class="header">
        <img src="/static/img/logo_negro_y_blanco.png" alt="Logo Amilgraf">
        <div>
            <h1>Sistema de Gestión de Placas</h1>
            <p>Consulta de envíos</p>
        </div>

        {% if current_user.is_authenticated %}
        <div style="margin-left: auto; margin-right: 40px; text-align: right; font-size: 0.9rem;">
            Logueado como: <strong>{{ current_user.email }}</strong>
            <br>
            
            <!-- Enlaces de Navegación -->
            <a href="{{ url_for('envios_page') }}" style="color: #FFC107; text-decoration: underline; font-weight: 600; margin-right: 15px;">
                Ver Envíos
            </a>
            
            <a href="{{ url_for('logout') }}" style="color: #FFC107; text-decoration: underline; font-weight: 600;">
                Cerrar Sesión
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Contenido del Panel de Pagos -->
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="section-title">Panel de Pagos Pendientes</h2>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <ul class="list-group" id="payment-list">
                    
                    {% if envios %}
                        {% for envio in envios %}
                        <li class="list-group-item" data-id="{{ envio.id }}">
                            <div class="payment-info">
                                <strong>{{ envio.asunto }}</strong>
                                <span>|</span>
                                S/ {{ "%.2f"|format(envio.costo_total) }}
                                <span>|</span>
                                <small>ID: {{ envio.id }} | {{ envio.destinatario }}</small>
                            </div>
                            <div class="payment-actions">
                                <input type="text" class="form-control form-control-dark nro-operacion-input" placeholder="Nro. Op (Opcional)">
                                <button class="btn btn-warning btn-sm pagar-btn">
                                    Marcar Pagado
                                </button>
                            </div>
                        </li>
                        {% endfor %}
                    {% else %}
                        <li class="list-group-item text-center">
                            ¡Felicidades! No hay ningún pago pendiente.
                        </li>
                    {% endif %}
                    
                </ul>
            </div>
        </div>
    </div>

    <!-- Contenedor para mensajes de feedback -->
    <div id="feedback-message" class="feedback-message"></div>


    <script>
        // Muestra un mensaje flotante de éxito o error
        function showFeedback(message, isSuccess = true) {
            const feedbackElement = document.getElementById('feedback-message');
            feedbackElement.textContent = message;
            feedbackElement.className = isSuccess ? 'feedback-message feedback-success' : 'feedback-message feedback-error';
            feedbackElement.style.display = 'block';

            setTimeout(() => {
                feedbackElement.style.display = 'none';
            }, 3000);
        }

        document.getElementById('payment-list').addEventListener('click', async (e) => {
            // Solo nos interesa si hicieron clic en el botón de pagar
            if (e.target.classList.contains('pagar-btn')) {
                
                const boton = e.target;
                const item = boton.closest('.list-group-item');
                const envioId = item.dataset.id;
                const inputOperacion = item.querySelector('.nro-operacion-input');
                const nroOperacion = inputOperacion.value.trim();

                // Deshabilitar botón para evitar doble clic
                boton.disabled = true;
                boton.textContent = 'Pagando...';

                try {
                    const response = await fetch('/api/admin/marcar_pagado', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            id: envioId,
                            nro_operacion: nroOperacion || null // Enviar null si está vacío
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // ¡Éxito! Ocultar la fila
                        item.style.transition = 'opacity 0.5s ease';
                        item.style.opacity = '0.3';
                        showFeedback('¡Pago registrado con éxito!', true);
                        
                        // Opcional: eliminarlo después de la animación
                        setTimeout(() => {
                            item.remove();
                            // Verificar si la lista está vacía
                            if (document.getElementById('payment-list').children.length === 0) {
                                document.getElementById('payment-list').innerHTML = `
                                    <li class="list-group-item text-center">
                                        ¡Felicidades! No hay ningún pago pendiente.
                                    </li>
                                `;
                            }
                        }, 500);

                    } else {
                        // Error manejado por el backend
                        console.error('Error al marcar pagado:', data.message);
                        showFeedback(`Error: ${data.message}`, false);
                        boton.disabled = false;
                        boton.textContent = 'Marcar Pagado';
                    }

                } catch (error) {
                    // Error de red
                    console.error('Error de red:', error);
                    showFeedback('Error de red. Intenta de nuevo.', false);
                    boton.disabled = false;
                    boton.textContent = 'Marcar Pagado';
                }
            }
        });
    </script>

</body>
</html>