<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Placas - Envíos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    
    <script>
        const currentUserRole = '{{ current_user_role | default("proveedor") }}';
    </script>
    
    <style>
        /* Estilos generales */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }

        /* Cabecera */
        .header {
            background: linear-gradient(135deg, #1e1e1e, #2c2c2c);
            color: #ffffff;
            padding: 40px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .header img {
            width: 50px;
            height: 50px;
            margin-right: 15px;
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0;
        }
        .header p {
            font-size: 1.2rem;
            font-weight: 400;
            margin: 0;
        }

        /* Contenedor principal */
        .container-fluid { 
            max-width: 1400px; 
            margin: 0 auto;
            padding: 30px;
        }

        /* Estilos de la tabla */
        .table {
            margin-bottom: 0;
            color: #e0e0e0;
            width: 100%;
        }
        .table th {
            background-color: #2c2c2c;
            color: #FFC107;
            font-weight: 600;
            text-align: center;
            padding: 8px;
            border: none;
            white-space: nowrap; 
        }
        .table td {
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #333;
            white-space: nowrap; 
        }
        /* Celda de Asunto multilínea */
        .table th:nth-child(5),
        .table td:nth-child(5) {
            white-space: normal; 
            word-break: break-word; 
            min-width: 250px; 
            text-align: left; 
        }
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #4b4b4b;
        }
        .table-striped tbody tr:nth-of-type(odd) td {
            color: #ffffff;
        }
        .thead-dark th {
            background-color: #2c2c2c;
            color: #FFC107;
            border-color: #454d55;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table-striped tbody tr:hover {
            background-color: #444444;
            transition: background-color 0.3s ease;
        }
        
        /* Títulos y helpers */
        .section-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
        }
        .text-center { text-align: center; }
        .text-danger { color: #ff5252; font-weight: 500; }
        .card {
             background-color: #1e1e1e;
             border: none;
             border-radius: 16px;
        }

        /* --- ESTILOS DE ACORDEÓN DARK MODE --- */
        .accordion-item {
            background-color: #1e1e1e; 
            border: 1px solid #333; 
            margin-bottom: 10px;
            border-radius: 12px; 
            overflow: hidden; 
        }
        .accordion-header {
            border-bottom: none;
        }
        .accordion-button {
            background-color: #2c2c2c; 
            color: #ffffff; 
            font-weight: 600;
            border: none;
            box-shadow: none; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 1rem 1.25rem; /* Padding ajustado */
        }
        .accordion-button.collapsed {
             background-color: #2c2c2c;
        }
        .accordion-button:not(.collapsed) {
            background-color: #3a3a3a; 
            color: #FFC107; 
        }
        .accordion-button::after {
            filter: invert(1) grayscale(100%) brightness(200%);
            flex-shrink: 0;
        }
        .accordion-button:not(.collapsed)::after {
             filter: invert(79%) sepia(61%) saturate(1433%) hue-rotate(359deg) brightness(102%) contrast(105%);
             flex-shrink: 0; 
        }
        .accordion-body {
            background-color: #1e1e1e; 
            padding: 0; 
        }

        /* --- INICIO: NUEVOS ESTILOS PARA ENCABEZADO DE ACORDEÓN --- */
        .button-content-wrapper {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* Ocupa todo el espacio disponible a la izquierda */
            margin-right: 1.5rem; /* Deja espacio para el icono 'after' */
        }

        .button-title-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px; /* Espacio entre título y resumen */
        }
        
        .button-month-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: inherit; /* Hereda el color del botón (blanco o amarillo) */
        }
        
        /* Fila del Resumen Financiero */
        .button-summary-row {
            display: flex;
            flex-wrap: wrap; /* !IMPORTANTE para móvil */
            gap: 10px 20px; /* Espacio entre items */
            font-size: 0.9rem;
            font-weight: 400;
        }

        .button-summary-row .summary-item {
            color: #ccc;
            line-height: 1.4;
        }
        .button-summary-row .summary-item strong {
            font-weight: 700;
            margin-left: 4px;
        }
        .button-summary-row .summary-item.total strong {
            color: #ffffff;
        }
        .button-summary-row .summary-item.pagado strong {
            color: #28a745; /* Verde */
        }
        .button-summary-row .summary-item.pendiente strong {
            color: #fd7e14; /* Naranja */
        }
        /* --- FIN: NUEVOS ESTILOS --- */


        /* Estilos para la celda de Estado */
        .status-pagado {
            color: #28a745;
            font-weight: 600;
            display: block; 
        }
        .status-pendiente {
            color: #fd7e14;
            font-weight: 600;
        }
        .nro-operacion {
            font-size: 0.85em;
            color: #999;
            display: block; 
            line-height: 1;
        }
        
        /* --- ESTILOS PARA FILTROS Y BUSCADOR --- */
        .form-select-dark {
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        .form-select-dark:focus {
            background-color: #3a3a3a;
            color: #e0e0e0;
            border-color: #FFC107;
            box-shadow: 0 0 0 0.25rem rgba(255,193,7,.25);
        }
        
        /* Input de búsqueda dark */
        .form-control-dark {
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        .form-control-dark::placeholder {
            color: #888;
        }
        .form-control-dark:focus {
            background-color: #3a3a3a;
            color: #e0e0e0;
            border-color: #FFC107;
            box-shadow: 0 0 0 0.25rem rgba(255,193,7,.25);
        }

        /* Filtro de Admin */
        #admin-filter-container {
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #333;
        }
        #admin-filter-container label {
            font-weight: 600;
            margin-right: 10px;
            color: #FFC107;
        }
        
        /* */
        #search-container {
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid #333;
        }


        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            .accordion-button {
                /* Ya no forzamos flex-direction: column */
                align-items: flex-start; /* Alinear contenido arriba */
                position: relative; /* Para el posicionamiento absoluto del icono */
            }
            
            /* Posicionamos el icono en la esquina superior derecha */
            .accordion-button::after {
                position: absolute;
                top: 15px;
                right: 15px;
            }
            
            .button-title-row {
                 /* Dejar espacio para el icono de la esquina */
                padding-right: 30px; 
            }
            
            /* El .button-summary-row se ajustará solo gracias a 'flex-wrap' */

            .header {
                flex-direction: column;
                padding: 20px 0;
            }
            .header img {
                margin-right: 0;
                margin-bottom: 10px;
            }
            .header div[style*="margin-left: auto"] {
                margin: 15px 0 0 0 !important;
                text-align: center !important;
            }

            /* Filtros en móvil */
            #admin-filter-container, #search-container {
                display: flex;
                flex-direction: column;
            }
            #admin-filter-container label, #search-container label {
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="/static/img/logo_negro_y_blanco.png" alt="Logo Amilgraf">
        <div>
            <h1>Sistema de Gestión de Placas</h1>
            <p>Consulta de envíos</p>
        </div>

        {% if current_user.is_authenticated %}
        <div style="margin-left: auto; margin-right: 40px; text-align: right; font-size: 0.9rem;">
            Logueado como: <strong>{{ current_user.email }}</strong>
            <br>

            {% if current_user.is_admin %}
            <a href="{{ url_for('admin_pagos_page') }}" style="color: #FFC107; text-decoration: underline; font-weight: 600; margin-right: 15px;">
                Panel de Pagos
            </a>
            {% endif %}
            <a href="{{ url_for('logout') }}" style="color: #FFC107; text-decoration: underline; font-weight: 600;">
                Cerrar Sesión
            </a>
        </div>
        {% endif %}
    </div>

    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-12">
                <h2 class="section-title">Listado de Envíos</h2>
            </div>
        </div>
        
        {% if current_user_role == 'admin' %}
        <div class="row mb-4">
            <div class="col-12" id="admin-filter-container">
                <div class="d-flex align-items-center">
                    <label for="admin-proveedor-filter" class="form-label mb-0">Vista de Administrador:</label>
                    <select class="form-select form-select-dark w-auto" id="admin-proveedor-filter">
                        <option value="all" selected>Ver Todos los Proveedores</option>
                    </select>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="row mb-4">
            <div class="col-12" id="search-container">
                 <label for="search-input" class="form-label mb-0 me-2">Buscar:</label>
                 <input type="search" class="form-control form-control-dark" id="search-input" placeholder="Buscar por ID, Asunto, Destinatario, etc.">
            </div>
        </div>
        
        <div id="no-results-message" class="card" style="display: none;">
            <div class="card-body text-center">
                No se encontraron envíos que coincidan con la búsqueda.
            </div>
        </div>
        
        <div id="accordion-container">
            <div class="card">
                <div class="card-body text-center" id="accordion-loading-message">
                    Cargando envíos...
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Formateador de moneda (Soles Peruanos)
        const currencyFormatter = new Intl.NumberFormat('es-PE', {
            style: 'currency',
            currency: 'PEN',
            minimumFractionDigits: 2
        });

        // --- FUNCIÓN loadEnvios (ACTUALIZADA) ---
        async function loadEnvios(filtroProveedor = 'default') {
            const container = document.getElementById('accordion-container');
            container.innerHTML = `
                <div class="card">
                    <div class="card-body text-center" id="accordion-loading-message">
                        Cargando envíos...
                    </div>
                </div>`;
            
            const searchInput = document.getElementById('search-input');
            const noResultsMsg = document.getElementById('no-results-message');
            
            if (searchInput) searchInput.value = '';
            if (noResultsMsg) noResultsMsg.style.display = 'none';

            
            let apiUrl = '/api/envios';

            if (currentUserRole === 'admin') {
                apiUrl = `/api/envios?proveedor=${filtroProveedor}`;
            }

            try {
                const enviosResponse = await fetch(apiUrl);
                if (!enviosResponse.ok) {
                    if (enviosResponse.status === 401) {
                        window.location.href = '/login'; 
                        return;
                    }
                    if (enviosResponse.status === 403) {
                         throw new Error('No tienes permiso para ver esta información.');
                    }
                    throw new Error('Error en la respuesta de la API: ' + enviosResponse.status);
                }
                const groupedEnvios = await enviosResponse.json();

                container.innerHTML = '';

                if (groupedEnvios.length === 0) {
                    let mensaje = 'No se encontraron envíos registrados.';
                    if (currentUserRole === 'admin' && filtroProveedor !== 'default') {
                        mensaje = `No se encontraron envíos para el proveedor seleccionado.`;
                    }
                    container.innerHTML = `
                        <div class="card">
                            <div class="card-body text-center">
                                ${mensaje}
                            </div>
                        </div>`;
                    return;
                }

                const accordionWrapper = document.createElement('div');
                accordionWrapper.className = 'accordion';
                accordionWrapper.id = 'enviosAccordion';

                groupedEnvios.forEach((group, index) => {
                    const monthKey = group.mes_key; 
                    const monthDisplay = group.mes_display; 
                    const envios = group.envios; 

                    const totalMes = currencyFormatter.format(group.total_mes || 0);
                    const totalPagado = currencyFormatter.format(group.total_pagado || 0);
                    const totalPendiente = currencyFormatter.format(group.total_pendiente || 0);

                    const tableRows = envios.map(envio => {
                        const tamanoFormateado = envio.tamano;
                        const fechaFormateada = new Date(envio.fecha).toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        const costoFormateado = currencyFormatter.format(envio.costo_total || 0);

                        // --- INICIO DE LA CORRECCIÓN ---
                        // Limpiamos el dato 'estado_pago' en el frontend ANTES de usarlo.
                        const estado = (envio.estado_pago || 'Pendiente').trim();
                        // --- FIN DE LA CORRECCIÓN ---
                        
                        const operacion = envio.nro_operacion;
                        let estadoHtml = '';

                        if (estado === 'Pagado') { // Esta comparación ahora funcionará
                            estadoHtml = `<span class="status-pagado">Pagado</span>`;
                            if (operacion) {
                                estadoHtml += `<span class="nro-operacion">(${operacion})</span>`;
                            }
                        } else {
                            estadoHtml = `<span class="status-pendiente">Pendiente</span>`;
                        }
                        
                        const asuntoCell = `
                            <td style="white-space: normal; word-break: break-word; text-align: left; min-width: 250px;">
                                ${envio.asunto || 'Sin asunto'}
                            </td>`;

                        return `
                            <tr>
                                <td>${envio.id}</td>
                                <td>${tamanoFormateado}</td>
                                <td>${envio.cantidad_placas}</td>
                                <td>${envio.destinatario}</td>
                                ${asuntoCell}
                                <td>${fechaFormateada}</td>
                                <td>${costoFormateado}</td>
                                <td>${estadoHtml}</td> 
                            </tr>
                        `;
                    }).join(''); 

                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item';
                    
                    const isShow = index === 0 ? 'show' : '';
                    const isCollapsed = index === 0 ? '' : 'collapsed';
                    const isExpanded = index === 0 ? 'true' : 'false';

                    // --- INICIO: CAMBIO DE ESTRUCTURA DEL BOTÓN ---
                    const buttonHtml = `
                        <h2 class="accordion-header" id="heading-${monthKey}">
                            <button class="accordion-button ${isCollapsed}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${monthKey}" aria-expanded="${isExpanded}" aria-controls="collapse-${monthKey}">
                                
                                <div class="button-content-wrapper">
                                    
                                    <div class="button-title-row">
                                        <span class="button-month-title">${monthDisplay}</span>
                                        <span class="badge bg-secondary ms-2">${envios.length} envíos</span>
                                    </div>
                                    
                                    <div class="button-summary-row">
                                        <span class="summary-item total">Total: <strong>${totalMes}</strong></span>
                                        <span class="summary-item pagado">Pagado: <strong>${totalPagado}</strong></span>
                                        
                                        <span class="summary-item pendiente">Pendiente: <strong>${totalPendiente}</strong></span>
                                    </div>
                                </div>
                                
                                </button>
                        </h2>
                    `;
                    // --- FIN: CAMBIO DE ESTRUCTURA DEL BOTÓN ---


                    // HTML del Cuerpo (BODY)
                    const bodyHtml = `
                        <div id="collapse-${monthKey}" class="accordion-collapse collapse ${isShow}" aria-labelledby="heading-${monthKey}" data-bs-parent="#enviosAccordion">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Tamaño</th>
                                                <th>Cantidad</th>
                                                <th>Destinatario</th>
                                                <th>Asunto</th>
                                                <th>Fecha</th>
                                                <th>Costo Total</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tableRows}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    accordionItem.innerHTML = buttonHtml + bodyHtml;
                    accordionWrapper.appendChild(accordionItem);
                });

                container.appendChild(accordionWrapper);

            } catch (error) {
                console.error('Error al cargar datos:', error);
                container.innerHTML =
                    `<div class="card"><div class="card-body text-center text-danger">Error al cargar los datos: ${error.message}</div></div>`;
            }
        }

        // --- FUNCIÓN PARA CARGAR EL FILTRO DE ADMIN ---
        async function loadAdminFilter() {
            if (currentUserRole !== 'admin') {
                return;
            }

            const selectFilter = document.getElementById('admin-proveedor-filter');
            if (!selectFilter) return;

            try {
                const response = await fetch('/api/admin/lista_proveedores');
                if (!response.ok) {
                    throw new Error('No se pudo cargar la lista de proveedores');
                }
                const proveedoresEmails = await response.json();

                const separator = document.createElement('option');
                separator.disabled = true;
                separator.innerHTML = '--- Proveedores ---';
                selectFilter.appendChild(separator);

                proveedoresEmails.forEach(email => {
                    const option = document.createElement('option');
                    option.value = email;
                    option.textContent = email;
                    selectFilter.appendChild(option);
                });

            } catch (error) {
                console.error(error);
            }
        }
        
        // --- 5. FUNCIÓN DE BÚSQUEDA (ACTUALIZADA CON MANEJO DE ACORDEÓN) ---
        function setupSearchFilter() {
            const searchInput = document.getElementById('search-input');
            const noResultsMessage = document.getElementById('no-results-message');
            const accordionContainer = document.getElementById('accordion-container');

            if (!searchInput) return;

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                let totalMatchesFound = 0;
                
                const loadingMsg = document.getElementById('accordion-loading-message');
                if (loadingMsg) loadingMsg.style.display = 'none';

                const accordionItems = accordionContainer.querySelectorAll('.accordion-item');

                // --- CASO 1: El buscador está vacío (se borró la búsqueda) ---
                if (searchTerm.length === 0) {
                    accordionItems.forEach((item, index) => {
                        // 1. Mostrar el item de acordeón
                        item.style.display = ''; 

                        // 2. Mostrar todas las filas dentro de él
                        item.querySelectorAll('tbody tr').forEach(row => {
                            row.style.display = '';
                        });

                        // 3. Restaurar estado colapsado (solo el primero abierto)
                        const collapseElement = item.querySelector('.accordion-collapse');
                        if (collapseElement) {
                            // Obtenemos la instancia de Bootstrap para este acordeón
                            const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);
                            if (index === 0) {
                                bsCollapse.show(); // Abrir el primero
                            } else {
                                bsCollapse.hide(); // Cerrar los demás
                            }
                        }
                    });
                    noResultsMessage.style.display = 'none'; // Ocultar mensaje de no resultados
                    return; // Salir de la función
                }

                // --- CASO 2: Hay un término de búsqueda, filtramos ---
                accordionItems.forEach(item => {
                    let itemHasVisibleRows = false;
                    const rows = item.querySelectorAll('tbody tr');

                    rows.forEach(row => {
                        const rowText = row.textContent.toLowerCase();
                        if (rowText.includes(searchTerm)) {
                            row.style.display = ''; // Mostrar fila
                            itemHasVisibleRows = true;
                        } else {
                            row.style.display = 'none'; // Ocultar fila
                        }
                    });

                    // 3. Mostrar u ocultar el item de acordeón completo
                    if (itemHasVisibleRows) {
                        item.style.display = ''; // Mostrar mes
                        totalMatchesFound++;
                        
                        // --- ¡AQUÍ LA MAGIA! ---
                        // Forzamos a que el acordeón se expanda para mostrar el resultado
                        const collapseElement = item.querySelector('.accordion-collapse');
                        if (collapseElement) {
                            const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseElement);
                            bsCollapse.show(); // Forzar expansión
                        }
                        // ------------------------

                    } else {
                        item.style.display = 'none'; // Ocultar mes
                    }
                });

                // 4. Mostrar u ocultar el mensaje de "No Resultados"
                if (totalMatchesFound === 0 && accordionItems.length > 0) {
                    noResultsMessage.style.display = 'block';
                } else {
                    noResultsMessage.style.display = 'none';

                }
            });
        }


        // --- 6. INICIALIZACIÓN DE LA PÁGINA (Sin cambios) ---
        document.addEventListener('DOMContentLoaded', () => {
            loadEnvios('all');
            
            setupSearchFilter(); // Esta función ahora es más inteligente

            if (currentUserRole === 'admin') {
                loadAdminFilter();

                const selectFilter = document.getElementById('admin-proveedor-filter');
                if (selectFilter) {
                    selectFilter.addEventListener('change', (e) => {
                        const nuevoFiltro = e.target.value;
                        loadEnvios(nuevoFiltro);
                    });
                }
            }
        });
    </script>
</body>
</html>