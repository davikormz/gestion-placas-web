<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Placas - Envíos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales (sin cambios) */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
        }

        /* Cabecera (sin cambios) */
        .header {
            background: linear-gradient(135deg, #1e1e1e, #2c2c2c);
            color: #ffffff;
            padding: 40px 0;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .header img {
            width: 50px;
            height: 50px;
            margin-right: 15px;
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0;
        }
        .header p {
            font-size: 1.2rem;
            font-weight: 400;
            margin: 0;
        }

        /* Contenedor principal */
        .container-fluid { /* Usamos container-fluid para más espacio */
            max-width: 1400px; /* Un poco más ancho para PC */
            margin: 0 auto;
            padding: 30px;
        }

        /* Estilos de la tabla (ajustados para estar DENTRO del acordeón) */
        .table {
            margin-bottom: 0;
            color: #e0e0e0;
            width: 100%; /* La tabla debe ser responsive */
            /* ¡Ya no usamos table-layout: fixed ni min-width! */
        }
        .table th {
            background-color: #2c2c2c;
            color: #FFC107;
            font-weight: 600;
            text-align: center;
            padding: 8px;
            border: none;
            white-space: nowrap; /* Encabezados en una línea */
        }
        .table td {
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #333;
            white-space: nowrap; /* Celdas en una línea por defecto */
        }
        /* Celda de Asunto: Permitir que se rompa en varias líneas */
        .table th:nth-child(5),
        .table td:nth-child(5) {
            white-space: normal; /* Permitir wrap */
            word-break: break-word; /* Romper palabras largas */
            min-width: 250px; /* Darle un ancho mínimo */
            text-align: left; /* Alinear a la izquierda para mejor lectura */
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #4b4b4b;
        }
        .table-striped tbody tr:nth-of-type(odd) td {
            color: #ffffff;
        }
        .thead-dark th {
            background-color: #2c2c2c;
            color: #FFC107;
            border-color: #454d55;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .table-striped tbody tr:hover {
            background-color: #444444;
            transition: background-color 0.3s ease;
        }


        /* Títulos de sección */
        .section-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
        }

        /* Alineación y helpers (sin cambios) */
        .text-center { text-align: center; }
        .text-danger { color: #ff5252; font-weight: 500; }
        .card {
             background-color: #1e1e1e;
             border: none;
             border-radius: 16px;
        }

        /* --- NUEVOS ESTILOS PARA EL ACORDEÓN DARK MODE --- */
        .accordion-item {
            background-color: #1e1e1e; /* Fondo del item */
            border: 1px solid #333; /* Borde sutil */
            margin-bottom: 10px;
            border-radius: 12px; /* Bordes redondeados */
            overflow: hidden; /* Para que el borde redondeado funcione */
        }
        .accordion-header {
            border-bottom: none;
        }
        .accordion-button {
            background-color: #2c2c2c; /* Fondo del botón (mes) */
            color: #ffffff; /* Texto del botón */
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            box-shadow: none; /* Quitar sombra de Bootstrap */
        }
        /* Estilo del botón cuando está colapsado (cerrado) */
        .accordion-button.collapsed {
             background-color: #2c2c2c;
        }
        /* Estilo del botón cuando está expandido (abierto) */
        .accordion-button:not(.collapsed) {
            background-color: #3a3a3a; /* Un poco más claro al abrir */
            color: #FFC107; /* Color ámbar al estar activo */
        }
        /* Flecha del acordeón (Bootstrap usa un SVG) */
        .accordion-button::after {
            /* Filtro para cambiar el color del icono SVG de Bootstrap a blanco */
            filter: invert(1) grayscale(100%) brightness(200%);
        }
        .accordion-button:not(.collapsed)::after {
            /* Filtro para cambiar el icono a color ámbar cuando está abierto */
             filter: invert(79%) sepia(61%) saturate(1433%) hue-rotate(359deg) brightness(102%) contrast(105%);
        }
        
        .accordion-body {
            background-color: #1e1e1e; /* Fondo del contenido (la tabla) */
            padding: 0; /* Quitamos padding para que la tabla ocupe todo */
        }
        /* --------------------------------------------------- */


        /* Media query para móviles (sin cambios) */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                padding: 20px 0;
            }
            .header img {
                margin-right: 0;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Cabecera con logo y bloque de logout (sin cambios) -->
    <div class="header">
        <img src="/static/img/logo_negro_y_blanco.png" alt="Logo Amilgraf">
        <div>
            <h1>Sistema de Gestión de Placas</h1>
            <p>Consulta de envíos</p>
        </div>

        {% if current_user.is_authenticated %}
        <div style="margin-left: auto; margin-right: 40px; text-align: right; font-size: 0.9rem;">
            Logueado como: <strong>{{ current_user.email }}</strong>
            <br>
            <a href="{{ url_for('logout') }}" style="color: #FFC107; text-decoration: underline; font-weight: 600;">
                Cerrar Sesión
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Contenido principal -->
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="section-title">Listado de Envíos</h2>
            </div>
        </div>

        <!--
            CONTENEDOR DEL ACORDEÓN
            Ya no tenemos una <div class="card"> o <table> aquí.
            El JavaScript construirá el acordeón dentro de este div.
        -->
        <div id="accordion-container">
            <!-- El contenido se cargará dinámicamente -->
            <!-- Mostramos un indicador de carga inicial -->
            <div class="card">
                <div class="card-body text-center">
                    Cargando envíos...
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- FUNCIÓN loadEnvios (TOTALMENTE ACTUALIZADA) ---
        async function loadEnvios() {
            const container = document.getElementById('accordion-container');
            
            try {
                // 1. Cargar envíos (la API ahora devuelve datos agrupados)
                const enviosResponse = await fetch('/api/envios');
                if (!enviosResponse.ok) {
                    if (enviosResponse.status === 401) {
                        window.location.href = '/login'; // Redirigir si no está autorizado
                        return;
                    }
                    throw new Error('Error en la respuesta de la API: ' + enviosResponse.status);
                }
                const groupedEnvios = await enviosResponse.json();

                // Limpiar el contenedor (quitar "Cargando...")
                container.innerHTML = '';

                // 2. Verificar si hay envíos
                if (groupedEnvios.length === 0) {
                    container.innerHTML = `
                        <div class="card">
                            <div class="card-body text-center">
                                No se encontraron envíos registrados.
                            </div>
                        </div>`;
                    return;
                }

                // 3. Crear el 'wrapper' principal del acordeón
                const accordionWrapper = document.createElement('div');
                accordionWrapper.className = 'accordion';
                accordionWrapper.id = 'enviosAccordion';

                // 4. Iterar sobre cada GRUPO (cada mes)
                groupedEnvios.forEach((group, index) => {
                    const monthKey = group.mes_key; // ej: "2025-10"
                    const monthDisplay = group.mes_display; // ej: "Octubre 2025"
                    const envios = group.envios; // Array de envíos de ese mes

                    // 5. Crear el HTML de las FILAS (<tr>) para la tabla de este mes
                    const tableRows = envios.map(envio => {
                        const tamanoFormateado = envio.tamano;
                        const fechaFormateada = new Date(envio.fecha).toLocaleDateString('es-ES', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                        
                        // Definimos la celda de Asunto con estilos inline
                        // para permitir el 'wrap' (multilínea) y mejorar la legibilidad.
                        const asuntoCell = `
                            <td style="white-space: normal; word-break: break-word; text-align: left; min-width: 250px;">
                                ${envio.asunto || 'Sin asunto'}
                            </td>`;

                        return `
                            <tr>
                                <td>${envio.id}</td>
                                <td>${tamanoFormateado}</td>
                                <td>${envio.cantidad_placas}</td>
                                <td>${envio.destinatario}</td>
                                ${asuntoCell}
                                <td>${fechaFormateada}</td>
                                <td>${envio.costo_total}</td>
                            </tr>
                        `;
                    }).join(''); // Unimos todas las filas en un solo string

                    // 6. Crear el HTML del 'Accordion Item' completo
                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item';
                    
                    // Decidimos si este item debe estar abierto por defecto
                    // (Solo el primero, que es el mes más reciente)
                    const isShow = index === 0 ? 'show' : '';
                    const isCollapsed = index === 0 ? '' : 'collapsed';
                    const isExpanded = index === 0 ? 'true' : 'false';

                    accordionItem.innerHTML = `
                        <h2 class="accordion-header" id="heading-${monthKey}">
                            <button class="accordion-button ${isCollapsed}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${monthKey}" aria-expanded="${isExpanded}" aria-controls="collapse-${monthKey}">
                                ${monthDisplay}
                                <span class="badge bg-secondary ms-auto me-2">${envios.length} envíos</span>
                            </button>
                        </h2>
                        <div id="collapse-${monthKey}" class="accordion-collapse collapse ${isShow}" aria-labelledby="heading-${monthKey}" data-bs-parent="#enviosAccordion">
                            <div class="accordion-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>ID</th>
                                                <th>Tamaño</th>
                                                <th>Cantidad</th>
                                                <th>Destinatario</th>
                                                <th>Asunto</th>
                                                <th>Fecha</th>
                                                <th>Costo Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${tableRows}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 7. Añadir este item (de mes) al wrapper del acordeón
                    accordionWrapper.appendChild(accordionItem);
                });

                // 8. Añadir el acordeón completo al contenedor de la página
                container.appendChild(accordionWrapper);

            } catch (error) {
                console.error('Error al cargar datos:', error);
                container.innerHTML =
                    '<div class="card"><div class="card-body text-center text-danger">Error al cargar los datos. Por favor, intente recargar la página.</div></div>';
            }
        }

        // Cargar datos al iniciar la página
        document.addEventListener('DOMContentLoaded', loadEnvios);
    </script>
</body>
</html>